---
crossorigin: "anonymous";
---

<div class="terminal"></div>

<script>
    import { WebContainer } from "@webcontainer/api";
    import { Terminal } from "xterm";
    import { FitAddon } from "xterm-addon-fit";

    let webcontainerInstance: WebContainer;

    const terminalEl = document.querySelector(".terminal");
    console.log("booting webcontainer");
    webcontainerInstance = await WebContainer.boot();
    console.log("webcontainer booted");

    const terminal = new Terminal({
        convertEol: true,
    });

    const fitAddon = new FitAddon();

    terminal.loadAddon(fitAddon);
    terminal.open(terminalEl as HTMLElement);

    const shellProcess = await startShell(terminal);

    window.addEventListener("resize", () => {
        fitAddon.fit();
        shellProcess.resize({
            cols: terminal.cols,
            rows: terminal.rows,
        });
    });

    /**
     * @param {Terminal} terminal
     */
    async function startShell(terminal: Terminal) {
        const shellProcess = await webcontainerInstance.spawn("jsh", {
            terminal: {
                cols: terminal.cols,
                rows: terminal.rows,
            },
        });
        shellProcess.output.pipeTo(
            new WritableStream({
                write(data) {
                    terminal.write(data);
                },
            }),
        );

        const input = shellProcess.input.getWriter();
        terminal.onData((data) => {
            input.write(data);
        });

        return shellProcess;
    }
</script>
